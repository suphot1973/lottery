<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองเลขท้ายสองตัว - ฉลากกินแบ่งรัฐบาล</title>
    <link href="https://fonts.googleapis.com/css2?family=K2D:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'K2D', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #7f8c8d;
            font-weight: 400;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .admin-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .admin-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .summary-card.booked i { color: #e74c3c; }
        .summary-card.paid i { color: #27ae60; }
        .summary-card.total i { color: #3498db; }
        .summary-card.available i { color: #f39c12; }

        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .summary-label {
            font-size: 1rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        .numbers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .number-card {
            aspect-ratio: 1;
            border: 3px solid #ecf0f1;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            position: relative;
            overflow: hidden;
        }

        .number-card:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .number-card.available {
            border-color: #27ae60;
            background: linear-gradient(135deg, #d5f4e6, #a8e6cf);
            color: #27ae60;
        }

        .number-card.booked {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #fadbd8, #f1948a);
            color: #e74c3c;
            cursor: not-allowed;
        }

        .number-card.paid {
            border-color: #3498db;
            background: linear-gradient(135deg, #d6eaf8, #85c1e9);
            color: #3498db;
        }

        .number-card.winner {
            border-color: #f39c12;
            background: linear-gradient(135deg, #fdeaa7, #f6d55c);
            color: #f39c12;
            animation: winner-glow 2s infinite;
        }

        @keyframes winner-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(243, 156, 18, 0.5); }
            50% { box-shadow: 0 0 30px rgba(243, 156, 18, 0.8); }
        }

        .status-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .status-badge.booked { background: #e74c3c; }
        .status-badge.paid { background: #27ae60; }
        .status-badge.winner { background: #f39c12; }

        .data-table {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .search-box {
            padding: 10px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            width: 250px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ecf0f1;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #3498db;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-view {
            background: #27ae60;
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .close {
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            color: #bdc3c7;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .file-upload {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-upload input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-upload-label {
            display: block;
            padding: 12px 15px;
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .file-upload-label:hover {
            border-color: #3498db;
            background: #ebf3fd;
        }

        .submit-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(39, 174, 96, 0.4);
        }

        .submit-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #3498db, #2980b9);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-weight: 500;
            color: #2c3e50;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #ecf0f1;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            background: white;
            padding: 30px;
            text-align: center;
            margin-top: 50px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        .footer-text {
            color: #7f8c8d;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .footer-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin: 0 auto;
        }

        .winner-announcement {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.3);
            display: none;
        }

        .winner-announcement.show {
            display: block;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .winner-text {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .winner-numbers {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: 2px;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .numbers-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                gap: 10px;
                padding: 20px;
            }
            
            .number-card {
                font-size: 1.2rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
            
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div style="margin-top: 20px; font-size: 1.2rem; font-weight: 600; color: #2c3e50;">
                กำลังประมวลผล...
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <img src="https://raw.githubusercontent.com/suphot1973/Data/refs/heads/main/004.png" alt="Logo" class="logo">
        <div class="title">ระบบจองเลขท้ายสองตัว</div>
        <div class="subtitle">ฉลากกินแบ่งรัฐบาล</div>
    </div>

    <!-- Winner Announcement -->
    <div class="winner-announcement" id="winnerAnnouncement">
        <div class="winner-text">🎉 ประกาศผลรางวัล 🎉</div>
        <div class="winner-numbers" id="winnerNumbers">--</div>
    </div>

    <div class="container">
        <!-- Admin Panel -->
        <div class="admin-panel">
            <button class="admin-btn" onclick="showAdminLogin()">
                <i class="fas fa-user-shield"></i> เข้าสู่ระบบผู้ดูแล
            </button>
            <button class="admin-btn" onclick="showWinnerModal()" style="background: linear-gradient(45deg, #f39c12, #e67e22);">
                <i class="fas fa-trophy"></i> ประกาศผลรางวัล
            </button>
            <button class="admin-btn" onclick="generateReport()" style="background: linear-gradient(45deg, #9b59b6, #8e44ad);">
                <i class="fas fa-file-pdf"></i> สร้างรายงาน
            </button>
        </div>

        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="summary-card booked">
                <i class="fas fa-bookmark"></i>
                <div class="summary-number" id="bookedCount">0</div>
                <div class="summary-label">จองแล้ว</div>
            </div>
            <div class="summary-card paid">
                <i class="fas fa-check-circle"></i>
                <div class="summary-number" id="paidCount">0</div>
                <div class="summary-label">จ่ายแล้ว</div>
            </div>
            <div class="summary-card total">
                <i class="fas fa-coins"></i>
                <div class="summary-number" id="totalAmount">0</div>
                <div class="summary-label">รวมเงิน (บาท)</div>
            </div>
            <div class="summary-card available">
                <i class="fas fa-ticket-alt"></i>
                <div class="summary-number" id="availableCount">100</div>
                <div class="summary-label">เหลือ</div>
            </div>
        </div>

        <!-- Numbers Grid -->
        <div class="numbers-grid" id="numbersGrid">
            <!-- Numbers will be generated by JavaScript -->
        </div>

        <!-- Data Table -->
        <div class="data-table">
            <div class="table-header">
                <div class="table-title">
                    <i class="fas fa-table"></i> ข้อมูลการจอง
                </div>
                <input type="text" class="search-box" placeholder="ค้นหา..." id="searchBox" onkeyup="filterTable()">
            </div>
            <table class="table" id="dataTable">
                <thead>
                    <tr>
                        <th>เลข</th>
                        <th>ชื่อ</th>
                        <th>เบอร์โทร</th>
                        <th>สถานะ</th>
                        <th>วันที่จอง</th>
                        <th>สลิป</th>
                        <th>จัดการ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">จองเลข <span id="selectedNumber">--</span></div>
                <span class="close" onclick="closeModal('bookingModal')">&times;</span>
            </div>
            <form id="bookingForm">
                <div class="form-group">
                    <label class="form-label">ชื่อ-นามสกุล *</label>
                    <input type="text" class="form-input" id="customerName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">เบอร์โทรศัพท์ *</label>
                    <input type="tel" class="form-input" id="customerPhone" required>
                </div>
                <div class="form-group">
                    <label class="form-label">สถานะการจ่ายเงิน *</label>
                    <select class="form-select" id="paymentStatus" required>
                        <option value="">เลือกสถานะ</option>
                        <option value="รอจ่าย">รอจ่าย</option>
                        <option value="จ่ายแล้ว">จ่ายแล้ว</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">อัปโหลดสลิปโอนเงิน</label>
                    <div class="file-upload">
                        <input type="file" id="slipFile" accept="image/*">
                        <label for="slipFile" class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <div>คลิกเพื่อเลือกไฟล์สลิป</div>
                            <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: 5px;">
                                รองรับไฟล์ JPG, PNG, GIF
                            </div>
                        </label>
                    </div>
                    <div id="fileName" style="margin-top: 10px; color: #27ae60; font-weight: 500;"></div>
                </div>
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
                <button type="submit" class="submit-btn" id="submitBtn">
                    <i class="fas fa-save"></i> บันทึกการจอง
                </button>
            </form>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ข้อมูลการจอง</div>
                <span class="close" onclick="closeModal('infoModal')">&times;</span>
            </div>
            <div id="infoContent">
                <!-- Info content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">เข้าสู่ระบบผู้ดูแล</div>
                <span class="close" onclick="closeModal('adminModal')">&times;</span>
            </div>
            <form id="adminForm">
                <div class="form-group">
                    <label class="form-label">รหัสผ่าน</label>
                    <input type="password" class="form-input" id="adminPassword" placeholder="กรอกรหัสผ่าน">
                </div>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-sign-in-alt"></i> เข้าสู่ระบบ
                </button>
            </form>
        </div>
    </div>

    <!-- Winner Modal -->
    <div id="winnerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ประกาศผลรางวัล</div>
                <span class="close" onclick="closeModal('winnerModal')">&times;</span>
            </div>
            <form id="winnerForm">
                <div class="form-group">
                    <label class="form-label">เลขท้ายสองตัวที่ถูกรางวัล</label>
                    <input type="text" class="form-input" id="winnerNumber" placeholder="กรอกเลข 2 ตัว (00-99)" maxlength="2">
                </div>
                <button type="submit" class="submit-btn" style="background: linear-gradient(45deg, #f39c12, #e67e22);">
                    <i class="fas fa-trophy"></i> ประกาศผลรางวัล
                </button>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="footer-text">ระบบจองเลขท้ายสองตัว - ฉลากกินแบ่งรัฐบาล</div>
        <div class="footer-text">Powered by Google Apps Script</div>
        <img src="https://raw.githubusercontent.com/suphot1973/Data/refs/heads/main/004.png" alt="Footer Logo" class="footer-logo">
    </div>

    <script>
        // Global variables
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwhtGZNC34KFlq42T-qHu-U70eT7lt2Onb2T37V9kfq3INkty9kGiAsrHTp6TG6oOgq/exec';
        let bookingsData = [];
        let isAdmin = false;

        // Test connection to Google Apps Script
        async function testConnection() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                
                const response = await fetch(`${SCRIPT_URL}?action=test&t=${Date.now()}`, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                return response.ok;
            } catch (error) {
                console.error('Connection test failed:', error);
                return false;
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            generateNumbersGrid();
            setupEventListeners();
            
            // Test connection first
            const isConnected = await testConnection();
            
            if (isConnected) {
                await loadData();
                showWelcomeMessage();
            } else {
                // Show connection error
                Swal.fire({
                    title: 'ไม่สามารถเชื่อมต่อได้',
                    text: 'กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต หรือลองใหม่อีกครั้ง',
                    icon: 'error',
                    confirmButtonColor: '#e74c3c',
                    confirmButtonText: 'ลองใหม่',
                    showCancelButton: true,
                    cancelButtonText: 'ใช้งานแบบออฟไลน์'
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.reload();
                    } else {
                        // Initialize with empty data for offline use
                        bookingsData = [];
                        updateUI();
                        showWelcomeMessage();
                    }
                });
            }
        });

        // Generate numbers grid (00-99)
        function generateNumbersGrid() {
            const grid = document.getElementById('numbersGrid');
            grid.innerHTML = '';
            
            for (let i = 0; i < 100; i++) {
                const number = i.toString().padStart(2, '0');
                const card = document.createElement('div');
                card.className = 'number-card available';
                card.textContent = number;
                card.onclick = () => selectNumber(number);
                card.id = `card-${number}`;
                grid.appendChild(card);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // File upload change event
            document.getElementById('slipFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const fileName = document.getElementById('fileName');
                if (file) {
                    fileName.textContent = `เลือกไฟล์: ${file.name}`;
                    fileName.style.display = 'block';
                } else {
                    fileName.style.display = 'none';
                }
            });

            // Form submissions
            document.getElementById('bookingForm').addEventListener('submit', handleBookingSubmit);
            document.getElementById('adminForm').addEventListener('submit', handleAdminLogin);
            document.getElementById('winnerForm').addEventListener('submit', handleWinnerAnnouncement);
        }

        // Show welcome message
        function showWelcomeMessage() {
            Swal.fire({
                title: 'ยินดีต้อนรับ!',
                text: 'ระบบจองเลขท้ายสองตัว ฉลากกินแบ่งรัฐบาล',
                icon: 'success',
                confirmButtonText: 'เริ่มใช้งาน',
                confirmButtonColor: '#3498db'
            });
        }

        // Select number function
        function selectNumber(number) {
            const card = document.getElementById(`card-${number}`);
            
            if (card.classList.contains('booked') || card.classList.contains('paid')) {
                // Show booking info
                showBookingInfo(number);
                return;
            }
            
            // Show booking modal
            document.getElementById('selectedNumber').textContent = number;
            document.getElementById('bookingModal').style.display = 'block';
            
            // Reset form
            document.getElementById('bookingForm').reset();
            document.getElementById('fileName').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
        }

        // Show booking info
        function showBookingInfo(number) {
            const booking = bookingsData.find(b => b.number === number);
            if (!booking) return;

            const content = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 3rem; color: #e74c3c; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h3 style="color: #e74c3c; margin-bottom: 20px;">เลข ${number} จองแล้ว!</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <p><strong>ชื่อ:</strong> ${booking.name}</p>
                        <p><strong>เบอร์โทร:</strong> ${booking.phone}</p>
                        <p><strong>สถานะ:</strong> <span style="color: ${booking.status === 'จ่ายแล้ว' ? '#27ae60' : '#e74c3c'}">${booking.status}</span></p>
                        <p><strong>วันที่จอง:</strong> ${booking.date}</p>
                    </div>
                    <p style="color: #7f8c8d;">กรุณาเลือกเลขอื่น</p>
                </div>
            `;
            
            document.getElementById('infoContent').innerHTML = content;
            document.getElementById('infoModal').style.display = 'block';
        }

        // Handle booking form submission
        async function handleBookingSubmit(e) {
            e.preventDefault();
            
            const number = document.getElementById('selectedNumber').textContent;
            const name = document.getElementById('customerName').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const status = document.getElementById('paymentStatus').value;
            const fileInput = document.getElementById('slipFile');
            
            // Validate required fields
            if (!name || !phone || !status) {
                Swal.fire({
                    title: 'ข้อมูลไม่ครบ!',
                    text: 'กรุณากรอกข้อมูลให้ครบถ้วน',
                    icon: 'warning',
                    confirmButtonColor: '#e74c3c'
                });
                return;
            }

            // Validate phone number format
            if (!/^[0-9]{9,10}$/.test(phone)) {
                Swal.fire({
                    title: 'เบอร์โทรไม่ถูกต้อง!',
                    text: 'กรุณากรอกเบอร์โทรศัพท์ 9-10 หลัก',
                    icon: 'warning',
                    confirmButtonColor: '#e74c3c'
                });
                return;
            }

            // Show loading
            showLoading(true);
            showProgress(0);
            
            // Disable submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...';

            try {
                let slipData = null;
                
                // Handle file upload if exists
                if (fileInput.files && fileInput.files[0]) {
                    showProgress(25);
                    try {
                        slipData = await convertFileToBase64(fileInput.files[0]);
                    } catch (fileError) {
                        console.error('File conversion error:', fileError);
                        throw new Error('ไม่สามารถอัปโหลดไฟล์ได้');
                    }
                }

                showProgress(50);

                // Prepare data
                const bookingData = {
                    action: 'addBooking',
                    number: number,
                    name: name,
                    phone: phone,
                    status: status,
                    date: new Date().toLocaleDateString('th-TH', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    }),
                    slip: slipData
                };

                showProgress(75);

                // Send to Google Apps Script with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(bookingData),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                showProgress(90);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                showProgress(100);
                
                if (result && result.success) {
                    Swal.fire({
                        title: 'สำเร็จ!',
                        text: `จองเลข ${number} เรียบร้อยแล้ว`,
                        icon: 'success',
                        confirmButtonColor: '#27ae60',
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    closeModal('bookingModal');
                    await loadData(); // Reload data
                } else {
                    throw new Error(result?.message || 'ไม่สามารถบันทึกข้อมูลได้');
                }

            } catch (error) {
                console.error('Booking submission error:', error);
                
                let errorMessage = 'ไม่สามารถบันทึกข้อมูลได้';
                
                if (error.name === 'AbortError') {
                    errorMessage = 'การเชื่อมต่อหมดเวลา กรุณาลองใหม่อีกครั้ง';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด!',
                    text: errorMessage,
                    icon: 'error',
                    confirmButtonColor: '#e74c3c'
                });
            } finally {
                showLoading(false);
                hideProgress();
                
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> บันทึกการจอง';
            }
        }

        // Convert file to base64
        function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                // Validate file
                if (!file) {
                    reject(new Error('ไม่พบไฟล์'));
                    return;
                }

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    reject(new Error('ไฟล์มีขนาดใหญ่เกินไป (สูงสุด 5MB)'));
                    return;
                }

                // Check file type
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                if (!allowedTypes.includes(file.type)) {
                    reject(new Error('รองรับเฉพาะไฟล์ JPG, PNG, GIF เท่านั้น'));
                    return;
                }

                const reader = new FileReader();
                
                reader.onload = () => {
                    try {
                        const result = reader.result;
                        if (!result || typeof result !== 'string') {
                            reject(new Error('ไม่สามารถอ่านไฟล์ได้'));
                            return;
                        }

                        const base64 = result.split(',')[1];
                        if (!base64) {
                            reject(new Error('ไม่สามารถแปลงไฟล์ได้'));
                            return;
                        }

                        resolve({
                            data: base64,
                            name: file.name,
                            type: file.type,
                            size: file.size
                        });
                    } catch (error) {
                        reject(new Error('เกิดข้อผิดพลาดในการแปลงไฟล์'));
                    }
                };
                
                reader.onerror = () => {
                    reject(new Error('ไม่สามารถอ่านไฟล์ได้'));
                };
                
                reader.readAsDataURL(file);
            });
        }

        // Load data from Google Sheets
        async function loadData() {
            try {
                // Add timeout for data loading
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

                const response = await fetch(`${SCRIPT_URL}?action=getData&t=${Date.now()}`, {
                    method: 'GET',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result && result.success) {
                    bookingsData = result.data || [];
                    updateUI();
                } else {
                    console.warn('Failed to load data:', result?.message || 'Unknown error');
                    // Still update UI with empty data to show available numbers
                    bookingsData = [];
                    updateUI();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                
                if (error.name === 'AbortError') {
                    console.warn('Data loading timeout');
                }
                
                // Initialize with empty data if loading fails
                bookingsData = [];
                updateUI();
                
                // Show error only if it's not a timeout and not the first load
                if (error.name !== 'AbortError' && bookingsData.length === 0) {
                    Swal.fire({
                        title: 'ไม่สามารถโหลดข้อมูลได้',
                        text: 'กรุณารีเฟรชหน้าเว็บ หรือลองใหม่อีกครั้ง',
                        icon: 'warning',
                        confirmButtonColor: '#f39c12',
                        confirmButtonText: 'รีเฟรช',
                        showCancelButton: true,
                        cancelButtonText: 'ปิด'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            location.reload();
                        }
                    });
                }
            }
        }

        // Update UI with loaded data
        function updateUI() {
            updateNumbersGrid();
            updateSummaryCards();
            updateDataTable();
        }

        // Update numbers grid
        function updateNumbersGrid() {
            for (let i = 0; i < 100; i++) {
                const number = i.toString().padStart(2, '0');
                const card = document.getElementById(`card-${number}`);
                const booking = bookingsData.find(b => b.number === number);
                
                if (booking) {
                    card.className = 'number-card ' + (booking.status === 'จ่ายแล้ว' ? 'paid' : 'booked');
                    
                    // Add status badge
                    let badge = card.querySelector('.status-badge');
                    if (!badge) {
                        badge = document.createElement('div');
                        badge.className = 'status-badge';
                        card.appendChild(badge);
                    }
                    badge.className = 'status-badge ' + (booking.status === 'จ่ายแล้ว' ? 'paid' : 'booked');
                    badge.textContent = booking.status === 'จ่ายแล้ว' ? '✓' : '!';
                } else {
                    card.className = 'number-card available';
                    const badge = card.querySelector('.status-badge');
                    if (badge) badge.remove();
                }
            }
        }

        // Update summary cards
        function updateSummaryCards() {
            const bookedCount = bookingsData.length;
            const paidCount = bookingsData.filter(b => b.status === 'จ่ายแล้ว').length;
            const totalAmount = paidCount * 80; // Assuming 80 baht per number
            const availableCount = 100 - bookedCount;

            document.getElementById('bookedCount').textContent = bookedCount;
            document.getElementById('paidCount').textContent = paidCount;
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
            document.getElementById('availableCount').textContent = availableCount;
        }

        // Update data table
        function updateDataTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            bookingsData.forEach(booking => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-weight: 600; font-size: 1.1rem;">${booking.number}</td>
                    <td>${booking.name}</td>
                    <td>${booking.phone}</td>
                    <td>
                        <span style="padding: 5px 10px; border-radius: 15px; font-size: 0.9rem; font-weight: 500; 
                               background: ${booking.status === 'จ่ายแล้ว' ? '#d5f4e6' : '#fadbd8'}; 
                               color: ${booking.status === 'จ่ายแล้ว' ? '#27ae60' : '#e74c3c'};">
                            ${booking.status}
                        </span>
                    </td>
                    <td>${booking.date}</td>
                    <td>
                        ${booking.slipUrl ? 
                            `<button class="action-btn btn-view" onclick="viewSlip('${booking.slipUrl}')">
                                <i class="fas fa-eye"></i> ดู
                            </button>` : 
                            '<span style="color: #bdc3c7;">ไม่มี</span>'
                        }
                    </td>
                    <td>
                        ${isAdmin ? `
                            <button class="action-btn btn-edit" onclick="editBooking('${booking.number}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteBooking('${booking.number}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : '<span style="color: #bdc3c7;">-</span>'}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter table
        function filterTable() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // View slip
        function viewSlip(url) {
            window.open(url, '_blank');
        }

        // Admin functions
        function showAdminLogin() {
            document.getElementById('adminModal').style.display = 'block';
        }

        async function handleAdminLogin(e) {
            e.preventDefault();
            const password = document.getElementById('adminPassword').value;
            
            if (password === 'admin1234') {
                isAdmin = true;
                closeModal('adminModal');
                Swal.fire({
                    title: 'เข้าสู่ระบบสำเร็จ!',
                    text: 'คุณสามารถจัดการข้อมูลได้แล้ว',
                    icon: 'success',
                    confirmButtonColor: '#27ae60'
                });
                updateDataTable();
            } else {
                Swal.fire({
                    title: 'รหัสผ่านไม่ถูกต้อง!',
                    text: 'กรุณาตรวจสอบรหัสผ่านอีกครั้ง',
                    icon: 'error',
                    confirmButtonColor: '#e74c3c'
                });
            }
        }

        // Edit booking
        function editBooking(number) {
            // Implementation for editing booking
            Swal.fire({
                title: 'แก้ไขการจอง',
                text: `แก้ไขข้อมูลเลข ${number}`,
                icon: 'info',
                confirmButtonColor: '#3498db'
            });
        }

        // Delete booking
        async function deleteBooking(number) {
            const result = await Swal.fire({
                title: 'ยืนยันการลบ?',
                text: `คุณต้องการลบการจองเลข ${number} หรือไม่?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e74c3c',
                cancelButtonColor: '#95a5a6',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });

            if (result.isConfirmed) {
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({
                            action: 'deleteBooking',
                            number: number
                        })
                    });

                    const deleteResult = await response.json();
                    
                    if (deleteResult.success) {
                        Swal.fire({
                            title: 'ลบสำเร็จ!',
                            text: `ลบการจองเลข ${number} เรียบร้อยแล้ว`,
                            icon: 'success',
                            confirmButtonColor: '#27ae60'
                        });
                        loadData();
                    } else {
                        throw new Error(deleteResult.message);
                    }
                } catch (error) {
                    Swal.fire({
                        title: 'เกิดข้อผิดพลาด!',
                        text: 'ไม่สามารถลบข้อมูลได้',
                        icon: 'error',
                        confirmButtonColor: '#e74c3c'
                    });
                }
            }
        }

        // Show winner modal
        function showWinnerModal() {
            document.getElementById('winnerModal').style.display = 'block';
        }

        // Handle winner announcement
        async function handleWinnerAnnouncement(e) {
            e.preventDefault();
            const winnerNumber = document.getElementById('winnerNumber').value;
            
            if (!/^\d{2}$/.test(winnerNumber)) {
                Swal.fire({
                    title: 'รูปแบบไม่ถูกต้อง!',
                    text: 'กรุณากรอกเลข 2 ตัว (00-99)',
                    icon: 'warning',
                    confirmButtonColor: '#e74c3c'
                });
                return;
            }

            try {
                // Update winner announcement
                document.getElementById('winnerNumbers').textContent = winnerNumber;
                document.getElementById('winnerAnnouncement').classList.add('show');
                
                // Update number card to winner status
                const card = document.getElementById(`card-${winnerNumber}`);
                if (card) {
                    card.classList.add('winner');
                }

                // Send notification
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify({
                        action: 'announceWinner',
                        number: winnerNumber
                    })
                });

                closeModal('winnerModal');
                
                Swal.fire({
                    title: '🎉 ประกาศผลรางวัลแล้ว!',
                    text: `เลขท้ายสองตัวที่ถูกรางวัล: ${winnerNumber}`,
                    icon: 'success',
                    confirmButtonColor: '#f39c12'
                });

            } catch (error) {
                console.error('Error announcing winner:', error);
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด!',
                    text: 'ไม่สามารถประกาศผลรางวัลได้',
                    icon: 'error',
                    confirmButtonColor: '#e74c3c'
                });
            }
        }

        // Generate report
        function generateReport() {
            const reportData = {
                totalBookings: bookingsData.length,
                paidBookings: bookingsData.filter(b => b.status === 'จ่ายแล้ว').length,
                totalRevenue: bookingsData.filter(b => b.status === 'จ่ายแล้ว').length * 80,
                date: new Date().toLocaleDateString('th-TH')
            };

            Swal.fire({
                title: 'รายงานสรุป',
                html: `
                    <div style="text-align: left; padding: 20px;">
                        <p><strong>วันที่:</strong> ${reportData.date}</p>
                        <p><strong>จำนวนการจองทั้งหมด:</strong> ${reportData.totalBookings} เลข</p>
                        <p><strong>จำนวนที่จ่ายแล้ว:</strong> ${reportData.paidBookings} เลข</p>
                        <p><strong>รายรับรวม:</strong> ${reportData.totalRevenue.toLocaleString()} บาท</p>
                    </div>
                `,
                icon: 'info',
                confirmButtonColor: '#3498db'
            });
        }

        // Utility functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showProgress(percent) {
            const container = document.getElementById('progressContainer');
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            
            container.style.display = 'block';
            fill.style.width = percent + '%';
            text.textContent = percent + '%';
        }

        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96d1de8cc77ece66',t:'MTc1NDg1MzgyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <p>ระบบจองเลขท้ายสองตัว - ฉลากกินแบ่งรัฐบาล</p>
    <p>กรุณาใช้ Web App URL เพื่อเข้าถึงระบบ</p>
  </body>
</html>
