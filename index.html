<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ระบบจองเลขท้ายสองตัว</title>
  <link href="https://fonts.googleapis.com/css2?family=K2D:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    /* CSS styles remain the same as before */
    /* ... (unchanged CSS from previous version) ... */
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://raw.githubusercontent.com/suphot1973/Data/refs/heads/main/004.png" alt="Logo" class="logo">
      <h1 class="app-title">ระบบจองเลขท้ายสองตัว</h1>
    </div>
    
    <div class="summary-cards">
      <div class="card">
        <h3>จำนวนหมายเลขที่จอง</h3>
        <div class="value" id="reservedCount">0</div>
        <div class="label">หมายเลข</div>
      </div>
      <div class="card">
        <h3>จ่ายเงินแล้ว</h3>
        <div class="value" id="paidCount">0</div>
        <div class="label">คน</div>
      </div>
      <div class="card">
        <h3>จำนวนเงินรวม</h3>
        <div class="value" id="totalAmount">0</div>
        <div class="label">บาท</div>
      </div>
      <div class="card">
        <h3>หมายเลขว่าง</h3>
        <div class="value" id="availableCount">100</div>
        <div class="label">หมายเลข</div>
      </div>
    </div>
    
    <h2 class="section-title">เลือกหมายเลข (00-99)</h2>
    
    <div class="numbers-grid" id="numbersGrid">
      <!-- Numbers will be generated by JavaScript -->
    </div>
    
    <div class="action-bar">
      <button class="btn btn-primary" id="btnAnnounceWinner">
        <i class="fas fa-bullhorn"></i> ประกาศเลขถูกรางวัล
      </button>
      <button class="btn btn-success" id="btnPrintReport">
        <i class="fas fa-print"></i> พิมพ์รายงาน
      </button>
      <button class="btn btn-warning" id="btnAdminLogin">
        <i class="fas fa-lock"></i> เข้าสู่ระบบ Admin
      </button>
    </div>
    
    <div class="admin-section">
      <h2 class="section-title">ประกาศเลขถูกรางวัล</h2>
      <div class="winning-number-display" id="winningNumberDisplay">
        <!-- Winning number will be loaded from server -->
      </div>
    </div>
    
    <div class="admin-panel" id="adminPanel">
      <h2 class="section-title">แผงควบคุมผู้ดูแลระบบ</h2>
      
      <div class="admin-controls">
        <button class="btn btn-primary" id="btnRefreshData">
          <i class="fas fa-sync"></i> รีเฟรชข้อมูล
        </button>
        <button class="btn btn-success" id="btnAddWinner">
          <i class="fas fa-trophy"></i> ประกาศเลขถูกรางวัล
        </button>
        <button class="btn btn-warning" id="btnSendNotifications">
          <i class="fas fa-bell"></i> ส่งการแจ้งเตือน
        </button>
      </div>
      
      <div class="table-container">
        <table class="data-table" id="reservationsTable">
          <thead>
            <tr>
              <th>หมายเลข</th>
              <th>ชื่อ</th>
              <th>เบอร์โทร</th>
              <th>สถานะ</th>
              <th>สลิป</th>
              <th>การจัดการ</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Data will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="footer">
      <p>ระบบจองเลขท้ายสองตัว &copy; 2023 - พัฒนาโดยทีมงานมืออาชีพ</p>
      <p>ติดต่อ: 02-123-4567 | อีเมล: contact@lotto-system.com</p>
    </div>
  </div>
  
  <!-- Reservation Modal -->
  <div class="reservation-modal" id="reservationModal">
    <div class="modal-content">
      <h2 style="text-align: center; margin-bottom: 20px; color: var(--primary);">จองหมายเลข <span id="reserveNumber">00</span></h2>
      <div class="form-group">
        <label for="name">ชื่อ-สกุล</label>
        <input type="text" id="name" class="form-control" placeholder="กรอกชื่อ-สกุล">
      </div>
      <div class="form-group">
        <label for="phone">เบอร์โทรศัพท์</label>
        <input type="tel" id="phone" class="form-control" placeholder="กรอกเบอร์โทรศัพท์">
      </div>
      <div class="form-group">
        <label for="paymentStatus">สถานะการจ่ายเงิน</label>
        <select id="paymentStatus" class="form-control">
          <option value="pending">รอจ่าย</option>
          <option value="paid">จ่ายแล้ว</option>
        </select>
      </div>
      <div class="form-group">
        <label for="slip">อัปโหลดสลิปโอนเงิน (ถ้ามี)</label>
        <input type="file" id="slip" class="form-control" accept="image/*">
      </div>
      <div class="form-group" style="display: flex; justify-content: space-between; margin-top: 30px;">
        <button class="btn btn-danger" id="btnCancelReserve">ยกเลิก</button>
        <button class="btn btn-success" id="btnConfirmReserve">ยืนยันการจอง</button>
      </div>
    </div>
  </div>
  
  <!-- Progress Overlay -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="progress-container">
      <div class="progress-text">กำลังประมวลผลข้อมูล...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div id="progressMessage">โปรดรอสักครู่</div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Configuration
    const CONFIG = {
      WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbwhtGZNC34KFlq42T-qHu-U70eT7lt2Onb2T37V9kfq3INkty9kGiAsrHTp6TG6oOgq/exec',
      ADMIN_PASSWORD: 'admin1234',
      PRICE_PER_NUMBER: 100 // ราคาต่อหมายเลข
    };

    // Global variables
    let currentNumber = null;
    let reservations = [];
    let winningNumber = null;
    let isAdmin = false;

    // Initialize the number grid
    function initNumberGrid() {
      const grid = document.getElementById('numbersGrid');
      grid.innerHTML = '';
      
      for (let i = 0; i < 100; i++) {
        const num = i.toString().padStart(2, '0');
        const card = document.createElement('div');
        card.className = 'number-card';
        card.textContent = num;
        card.dataset.number = num;
        card.id = `number-${num}`;
        
        // Add reserved class if number is reserved
        const reservation = reservations.find(r => r.number === num);
        if (reservation) {
          card.classList.add(reservation.paymentStatus === 'paid' ? 'paid' : 'reserved');
          const label = document.createElement('div');
          label.className = 'reserved-label';
          label.textContent = reservation.paymentStatus === 'paid' ? 'จ่ายแล้ว' : 'จองแล้ว';
          card.appendChild(label);
        }
        
        card.addEventListener('click', () => handleNumberClick(num, card));
        grid.appendChild(card);
      }
    }

    // Update summary cards
    function updateSummaryCards() {
      const reservedCount = reservations.length;
      const paidCount = reservations.filter(r => r.paymentStatus === 'paid').length;
      const totalAmount = paidCount * CONFIG.PRICE_PER_NUMBER;
      const availableCount = 100 - reservedCount;
      
      document.getElementById('reservedCount').textContent = reservedCount;
      document.getElementById('paidCount').textContent = paidCount;
      document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
      document.getElementById('availableCount').textContent = availableCount;
    }

    // Update winning number display
    function updateWinningNumberDisplay() {
      const display = document.getElementById('winningNumberDisplay');
      if (winningNumber) {
        display.innerHTML = `
          <div style="text-align: center; font-size: 2rem; margin: 20px 0; background: rgba(46, 204, 113, 0.2); padding: 15px; border-radius: 10px;">
            <span style="color: #ffd700; font-weight: 700;">งวดล่าสุด: ${winningNumber.date}</span><br>
            <span style="font-size: 3rem; color: #2ecc71; font-weight: 700;">${winningNumber.number}</span>
          </div>
        `;
      } else {
        display.innerHTML = '<p style="text-align: center; color: #e74c3c;">ยังไม่ได้ประกาศเลขถูกรางวัล</p>';
      }
    }

    // Update admin table
    function updateAdminTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      
      reservations.forEach(reservation => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
          <td>${reservation.number}</td>
          <td>${reservation.name}</td>
          <td>${reservation.phone}</td>
          <td><span class="${reservation.paymentStatus === 'paid' ? 'paid' : 'pending'}">${reservation.paymentStatus === 'paid' ? 'จ่ายแล้ว' : 'รอจ่าย'}</span></td>
          <td>
            ${reservation.slipUrl ? 
              `<img src="${reservation.slipUrl}" class="thumbnail" alt="สลิปโอนเงิน">` : 
              '-'}
          </td>
          <td>
            <button class="action-btn btn-edit" data-id="${reservation.id}"><i class="fas fa-edit"></i></button>
            <button class="action-btn btn-delete" data-id="${reservation.id}"><i class="fas fa-trash"></i></button>
          </td>
        `;
        
        tbody.appendChild(row);
      });
      
      // Add event listeners to action buttons
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => editReservation(btn.dataset.id));
      });
      
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => deleteReservation(btn.dataset.id));
      });
    }

    // Handle number click
    function handleNumberClick(number, element) {
      if (element.classList.contains('reserved') || element.classList.contains('paid')) {
        const reservation = reservations.find(r => r.number === number);
        Swal.fire({
          title: 'หมายเลขถูกจองแล้ว',
          html: `หมายเลข <b>${number}</b> ถูกจองโดย<br>
                 <b>${reservation.name}</b> (${reservation.phone})<br>
                 สถานะ: <span class="${reservation.paymentStatus === 'paid' ? 'paid' : 'pending'}">${reservation.paymentStatus === 'paid' ? 'จ่ายแล้ว' : 'รอจ่าย'}</span>`,
          icon: 'info',
          confirmButtonText: 'ตกลง'
        });
      } else {
        currentNumber = number;
        document.getElementById('reserveNumber').textContent = number;
        document.getElementById('reservationModal').style.display = 'flex';
      }
    }

    // Show progress overlay
    function showProgress(message) {
      const overlay = document.getElementById('progressOverlay');
      const messageEl = document.getElementById('progressMessage');
      messageEl.textContent = message;
      overlay.style.display = 'flex';
      
      // Simulate progress
      let progress = 0;
      const progressFill = document.getElementById('progressFill');
      const interval = setInterval(() => {
        progress += Math.floor(Math.random() * 10) + 1;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
        }
        progressFill.style.width = `${progress}%`;
      }, 200);
      
      return interval;
    }

    // Hide progress overlay
    function hideProgress(interval) {
      clearInterval(interval);
      document.getElementById('progressOverlay').style.display = 'none';
      document.getElementById('progressFill').style.width = '0%';
    }

    // Admin login
    function adminLogin() {
      Swal.fire({
        title: 'เข้าสู่ระบบ Admin',
        html: `<input type="password" id="password" class="swal2-input" placeholder="รหัสผ่าน">`,
        confirmButtonText: 'เข้าสู่ระบบ',
        focusConfirm: false,
        preConfirm: () => {
          const password = Swal.getPopup().querySelector('#password').value;
          if (password !== CONFIG.ADMIN_PASSWORD) {
            Swal.showValidationMessage('รหัสผ่านไม่ถูกต้อง');
          }
          return password;
        }
      }).then((result) => {
        if (result.isConfirmed) {
          isAdmin = true;
          document.getElementById('adminPanel').style.display = 'block';
          document.getElementById('btnAdminLogin').innerHTML = '<i class="fas fa-user-cog"></i> Admin';
          Swal.fire('เข้าสู่ระบบสำเร็จ!', '', 'success');
        }
      });
    }

    // Load data from Google Sheets
    async function loadData() {
      const progressInterval = showProgress('กำลังโหลดข้อมูล...');
      
      try {
        // Fetch reservations
        const response = await fetch(`${CONFIG.WEB_APP_URL}?action=getReservations`);
        const data = await response.json();
        
        if (data.success) {
          reservations = data.data;
          updateSummaryCards();
          initNumberGrid();
          updateAdminTable();
        } else {
          throw new Error(data.message);
        }
        
        // Fetch winning number
        const winResponse = await fetch(`${CONFIG.WEB_APP_URL}?action=getWinningNumber`);
        const winData = await winResponse.json();
        
        if (winData.success) {
          winningNumber = winData.data;
          updateWinningNumberDisplay();
        }
        
        hideProgress(progressInterval);
      } catch (error) {
        hideProgress(progressInterval);
        Swal.fire('เกิดข้อผิดพลาด', `ไม่สามารถโหลดข้อมูล: ${error.message}`, 'error');
      }
    }

    // Save reservation
    async function saveReservation() {
      const name = document.getElementById('name').value;
      const phone = document.getElementById('phone').value;
      const paymentStatus = document.getElementById('paymentStatus').value;
      const fileInput = document.getElementById('slip');
      
      if (!name || !phone) {
        Swal.fire('กรอกข้อมูลไม่ครบ', 'กรุณากรอกชื่อและเบอร์โทรศัพท์', 'warning');
        return;
      }
      
      const progressInterval = showProgress('กำลังบันทึกข้อมูล...');
      
      // Prepare form data
      const formData = new FormData();
      formData.append('action', 'saveReservation');
      formData.append('number', currentNumber);
      formData.append('name', name);
      formData.append('phone', phone);
      formData.append('paymentStatus', paymentStatus);
      
      // Add file if exists
      if (fileInput.files.length > 0) {
        formData.append('slip', fileInput.files[0]);
      }
      
      try {
        const response = await fetch(CONFIG.WEB_APP_URL, {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        hideProgress(progressInterval);
        
        if (data.success) {
          document.getElementById('reservationModal').style.display = 'none';
          await loadData(); // Reload data
          Swal.fire('สำเร็จ!', 'บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        hideProgress(progressInterval);
        Swal.fire('เกิดข้อผิดพลาด', `บันทึกข้อมูลไม่สำเร็จ: ${error.message}`, 'error');
      }
    }

    // Announce winner
    async function announceWinner() {
      const { value: number } = await Swal.fire({
        title: 'ประกาศเลขถูกรางวัล',
        input: 'text',
        inputLabel: 'กรอกหมายเลขที่ถูกรางวัล (00-99)',
        inputPlaceholder: '00',
        showCancelButton: true,
        inputValidator: (value) => {
          if (!value || value.length !== 2 || isNaN(value)) {
            return 'กรุณากรอกหมายเลขที่ถูกต้อง (00-99)';
          }
        }
      });
      
      if (number) {
        const progressInterval = showProgress('กำลังประกาศเลขถูกรางวัล...');
        
        try {
          const formData = new FormData();
          formData.append('action', 'announceWinner');
          formData.append('winningNumber', number);
          
          const response = await fetch(CONFIG.WEB_APP_URL, {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          hideProgress(progressInterval);
          
          if (data.success) {
            winningNumber = {
              number: number,
              date: new Date().toLocaleDateString('th-TH')
            };
            updateWinningNumberDisplay();
            Swal.fire('ประกาศสำเร็จ!', `ประกาศหมายเลข ${number} เป็นหมายเลขถูกรางวัล`, 'success');
          } else {
            throw new Error(data.message);
          }
        } catch (error) {
          hideProgress(progressInterval);
          Swal.fire('เกิดข้อผิดพลาด', `ประกาศไม่สำเร็จ: ${error.message}`, 'error');
        }
      }
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', async () => {
      // Load initial data
      await loadData();
      
      // Event listeners
      document.getElementById('btnAdminLogin').addEventListener('click', adminLogin);
      document.getElementById('btnCancelReserve').addEventListener('click', () => {
        document.getElementById('reservationModal').style.display = 'none';
      });
      
      document.getElementById('btnConfirmReserve').addEventListener('click', saveReservation);
      document.getElementById('btnAnnounceWinner').addEventListener('click', announceWinner);
      document.getElementById('btnRefreshData').addEventListener('click', loadData);
      
      document.getElementById('btnPrintReport').addEventListener('click', async () => {
        const progressInterval = showProgress('กำลังสร้างรายงาน...');
        
        try {
          const response = await fetch(`${CONFIG.WEB_APP_URL}?action=generateReport`);
          const data = await response.json();
          hideProgress(progressInterval);
          
          if (data.success && data.pdfUrl) {
            window.open(data.pdfUrl, '_blank');
            Swal.fire('สร้างรายงานสำเร็จ', 'เปิดรายงาน PDF ในแท็บใหม่แล้ว', 'success');
          } else {
            throw new Error(data.message || 'ไม่สามารถสร้างรายงานได้');
          }
        } catch (error) {
          hideProgress(progressInterval);
          Swal.fire('เกิดข้อผิดพลาด', `ไม่สามารถสร้างรายงาน: ${error.message}`, 'error');
        }
      });
      
      document.getElementById('btnSendNotifications').addEventListener('click', async () => {
        const progressInterval = showProgress('กำลังส่งการแจ้งเตือน...');
        
        try {
          const response = await fetch(`${CONFIG.WEB_APP_URL}?action=sendNotifications`);
          const data = await response.json();
          hideProgress(progressInterval);
          
          if (data.success) {
            Swal.fire('ส่งการแจ้งเตือนสำเร็จ', 'แจ้งเตือนไปยัง Line OA และผู้เกี่ยวข้องแล้ว', 'success');
          } else {
            throw new Error(data.message);
          }
        } catch (error) {
          hideProgress(progressInterval);
          Swal.fire('เกิดข้อผิดพลาด', `ส่งการแจ้งเตือนไม่สำเร็จ: ${error.message}`, 'error');
        }
      });
    });
  </script>
</body>
</html>
